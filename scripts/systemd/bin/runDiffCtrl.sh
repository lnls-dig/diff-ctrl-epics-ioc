#!/usr/bin/env bash

set -u

if [ -z "$DIFF_INSTANCE" ]; then
    echo "DIFF_INSTANCE environment variable is not set." >&2
    exit 1
fi

export DIFF_CURRENT_PV_AREA_PREFIX=DIFF_${DIFF_INSTANCE}_PV_AREA_PREFIX
export DIFF_CURRENT_PV_DEVICE_PREFIX=DIFF_${DIFF_INSTANCE}_PV_DEVICE_PREFIX
export DIFF_CURRENT_CTRL_NEG_PREFIX=DIFF_${DIFF_INSTANCE}_CTRL_NEG_PREFIX
export DIFF_CURRENT_CTRL_POS_PREFIX=DIFF_${DIFF_INSTANCE}_CTRL_POS_PREFIX
export DIFF_CURRENT_EGU=DIFF_${DIFF_INSTANCE}_EGU
export DIFF_CURRENT_DEVICE_TELNET_PORT_SUFFIX=DIFF_${DIFF_INSTANCE}_TELNET_PORT_SUFFIX
# Only works with bash
export DIFF_PV_AREA_PREFIX=${!DIFF_CURRENT_PV_AREA_PREFIX}
export DIFF_PV_DEVICE_PREFIX=${!DIFF_CURRENT_PV_DEVICE_PREFIX}
export DIFF_CTRL_NEG_PREFIX=${!DIFF_CURRENT_CTRL_NEG_PREFIX}
export DIFF_CTRL_POS_PREFIX=${!DIFF_CURRENT_CTRL_POS_PREFIX}
export DIFF_EGU=${!DIFF_CURRENT_EGU}
export DIFF_DEVICE_TELNET_PORT=${PROCSERV_DIFF_PORT_PREFIX}${!DIFF_CURRENT_DEVICE_TELNET_PORT_SUFFIX}

if [ -z "${DIFF_CURRENT_DEVICE_TELNET_PORT_SUFFIX}" ]; then
    echo "TELNET port is not set." >&2
    exit 1
fi

./runProcServ.sh \
    -n "${DIFF_CTRL_NEG_PREFIX}" \
    -p "${DIFF_CTRL_POS_PREFIX}" \
    -P "${DIFF_PV_AREA_PREFIX}" \
    -R "${DIFF_PV_DEVICE_PREFIX}" \
    -g "${DIFF_EGU}"

